import keyToKeyCodeMap from"../js/keyToKeyCodeMap.js";import gameConfig from"../js/gameConfig.js";export const params=new URLSearchParams(window.location.search);export const ANDROID_PORTRAIT=0;export const ANDROID_LANDSCAPE=1;export const GAME_VIEW_PORTRAIT=0;export const GAME_VIEW_LANDSCAPE=1;export const AppMethods={changeLayout(e){this.selectLayout=e.target.value,localStorage.setItem(`selectLayout:${this.game}`,this.selectLayout),this.loadKeyboardLayout()},keyToKeyCode:e=>e?keyToKeyCodeMap[e.toLowerCase()]??0:0,changeQuality(e){axios.post("https://api.prod.cloudmoonapp.com/phone/action",{android_id:this.userId,game_name:this.game,instance_id:this.androidInstanceId||"local",key:"quality",value:e},{headers:{"X-User-Token":this.token}}).then((e=>{if(0===e.data.code)return Swal.fire({theme:"material-ui-dark",toast:!0,position:"bottom",icon:"success",title:`Streaming quality set to ${this.quality}`,showConfirmButton:!1,timer:2e3,timerProgressBar:!0}),void(this.prevQuality=this.quality);this.quality=this.prevQuality,"VIP level too low"===e.data.message?Swal.fire({theme:"material-ui-dark",text:"Upgrade to Premium Plan for HD.",icon:"info",showCancelButton:!0,confirmButtonText:"Upgrade",target:document.body}).then((e=>{if(e.isConfirmed){const e=new URL("https://shop.cloudmoonapp.com/shop");this.token&&e.searchParams.set("token",this.token),this.email&&e.searchParams.set("email",this.email),window.open(e.toString(),"_blank")}})):Swal.fire({theme:"material-ui-dark",toast:!0,position:"bottom",icon:"warning",title:e.data.message,showConfirmButton:!1,timer:2e3,timerProgressBar:!0})})).catch((e=>{this.quality=this.prevQuality}))},checkAD(){this.token&&(this.isMobile()||axios.post("https://api.prod.cloudmoonapp.com/web/ad",{game_name:this.game},{headers:{"X-User-Token":this.token}}).then((e=>{if(0===e.data.code){if(this.initOrientation=e.data.data.initOrientation,this.unlimitUser=true,0===this.initOrientation&&e.data.data.showAD){this.$refs.containerDiv.clientWidth-this.videoWidth<600&&(e.data.data.showAD=!1)}else{this.$refs.containerDiv.clientWidth/this.$refs.containerDiv.clientHeight<=1.5&&(this.hideVertical=!0)}e.data.data.showAD&&(gtag("event","user_show_ad"),detectAdBlock()?.then((e=>{e?(gtag("event","user_block_ad"),this.isBlocked=!0,this.unlimitUser?this.adPlaceholder="Ad blocked — Unlimited time off":this.adPlaceholder="Ad blocked — Reduced free time"):(this.loadADiv=!0,gtag("event","user_unblock_ad"),this.loadADiv?(this.adPlaceholder="Advertisement",this.adBlockTimer=setInterval((()=>{detectAdBlock()?.then((e=>{this.isBlocked=e,this.sendDataChannelMessage("adBlock>"+e)}))}),5e3)):this.adPlaceholder="Ad blocked")})),this.showADiv=!0)}})).catch((e=>{})))},probeScript(e,t=!0,i=5e3){const s=setTimeout((()=>{}),i);function o(e){clearTimeout(s)}const n=document.createElement("script");n.src=e,n.async=t,n.onload=()=>{((e,t=100,i=5e3)=>new Promise(((s,o)=>{let n=Date.now()+i;!function i(){let r=e();r?s(r):Date.now()>n?o("__VM timeout"):setTimeout(i,t)}()})))((()=>window&&window.__VM&&window.__VM.loaded),200,4e3).then((()=>{clearTimeout(s)})).catch((e=>{o()}))},n.onerror=()=>{o()},document.head.appendChild(n)},changeEditKeyboard(){this.isEditKeyboard&&(this.openMenu=!1)},async resetGameConfig(){localStorage.removeItem(`keyboardLayout:${this.selectLayout}:${this.checkGame}:center`),localStorage.removeItem(`keyboardLayout:${this.selectLayout}:${this.checkGame}:newKeyboard`);const e=await fetch(`https://api.prod.cloudmoonapp.com/web/game_config?pkg=${this.checkGame}`).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).catch((e=>(log.error("request error:",e),null)));let t={};0===e.code?(log.info("use origin config"),t=e.data.config):(log.info("use remote config"),t=this.gameConfig[this.checkGame]??{}),this.currentGameConfig=t,this.supportPointerLock=t?.pointerLock??!1,this.supportRightClick=t?.supportRightClick??!1,this.supportLeftRocker=t?.supportLeftRocker??!1,this.supportRightRocker=t?.supportRightRocker??!1,this.center=t?.center??{x:0,y:0}},startDragLeftRocker(e){if(!this.isEditKeyboard)return;if(!this.supportLeftRocker)return;const t=e.currentTarget,i=t.getBoundingClientRect();t.parentElement.getBoundingClientRect();this.draggingLeftRocker=!0,this.offsetX=e.clientX-i.left,this.offsetY=e.clientY-i.top,t.classList.add("dragging"),document.addEventListener("pointermove",this.onPointerMoveLeftRocker),document.addEventListener("pointerup",this.endDragLeftRocker)},onPointerMoveLeftRocker(e){if(!this.draggingLeftRocker)return;if(!this.currentGameConfig.center)return;const t=document.querySelector(".keyboard").getBoundingClientRect(),i=document.querySelector(".l-rocker"),s=i?.offsetWidth||26,o=i?.offsetHeight||26,n=e.clientX-t.left-this.offsetX+s/2,r=e.clientY-t.top-this.offsetY+o/2,a=Math.max(0,Math.min(t.width,n)),h=Math.max(0,Math.min(t.height,r)),c=Math.round(a/t.width*1280),d=Math.round(h/t.height*720);this.center={x:c,y:d},this.$set(this.currentGameConfig,"center",{x:c,y:d})},endDragLeftRocker(){if(!this.draggingLeftRocker)return;const e=document.querySelector(".l-rocker");e&&e.classList.remove("dragging"),this.draggingLeftRocker=!1,document.removeEventListener("pointermove",this.onPointerMoveKey),document.removeEventListener("pointerup",this.endDragKey),this.saveKeyboardLayout()},startDragKey(e,t){if(!this.isEditKeyboard)return;if(!this.currentGameConfig.keyBoard[t])return;const i=e.currentTarget,s=i.getBoundingClientRect();i.parentElement.getBoundingClientRect();this.draggingKey=t,this.offsetX=e.clientX-s.left,this.offsetY=e.clientY-s.top,i.classList.add("dragging"),document.addEventListener("pointermove",this.onPointerMoveKey),document.addEventListener("pointerup",this.endDragKey)},onPointerMoveKey(e){if(!this.draggingKey)return;const t=this.currentGameConfig.keyBoard[this.draggingKey];if(!t)return;const i=document.querySelector(".keyboard").getBoundingClientRect(),s=document.querySelector(`.keyboard-key-${this.keyToKeyCode(t.key)}`),o=s?.offsetWidth||26,n=s?.offsetHeight||26,r=e.clientX-i.left-this.offsetX+o/2,a=e.clientY-i.top-this.offsetY+n/2,h=Math.max(0,Math.min(i.width,r)),c=Math.max(0,Math.min(i.height,a)),d=Math.round(h/i.width*1280),l=Math.round(c/i.height*720);this.$set(t,"coordinate",`${d},${l}`),this.$set(t,"location","")},endDragKey(e){if(!this.draggingKey)return;const t=this.currentGameConfig.keyBoard[this.draggingKey];if(!t)return;const i=document.querySelector(`.keyboard-key-${this.keyToKeyCode(t.key)}`).querySelector(".keyboard-key-text");i&&i.classList.remove("dragging"),this.draggingKey=null,document.removeEventListener("pointermove",this.onPointerMoveKey),document.removeEventListener("pointerup",this.endDragKey),this.saveKeyboardLayout()},async addKeyboardKey(){const e=(await new Promise((e=>{Swal.fire({theme:"material-ui-dark",title:"Press a key on your keyboard",html:'<input type="password" id="keyInput" style="opacity:0;position:absolute;">',showCancelButton:!0,showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>{const t=document.getElementById("keyInput");t.focus();const i=s=>{s.preventDefault(),t.removeEventListener("keydown",i),e({value:s}),Swal.close()};t.addEventListener("keydown",i)},willClose:()=>{e({value:null})}})}))).value;if(e){let t=this.keyToKeyCode(e.key.toLowerCase()),i=!0;if(this.supportLeftRocker&&(i=!1),t<=0||e.keyCode>=112&&e.keyCode<=123)Swal.fire({theme:"material-ui-dark",toast:!0,position:"bottom",icon:"error",title:"Invalid key binding.",showConfirmButton:!1,timer:2e3});else if(i||87!==t&&65!==t&&83!==t&&68!==t)if(log.info("Press Key: ",e),this.currentGameConfig.keyBoard[e.key.toLowerCase()])Swal.fire({theme:"material-ui-dark",toast:!0,position:"bottom",icon:"error",title:"Key already exists",showConfirmButton:!1,timer:2e3});else{let t=e.key;switch(t){case" ":t="Space";break;case"Escape":t="Esc";break;case"Control":t="Ctrl";break;case"Backspace":t="←";break;case"CapsLock":t="Caps";break;case"ArrowLeft":t="⬅️";break;case"ArrowRight":t="➡️";break;case"ArrowUp":t="⬆️";break;case"ArrowDown":t="⬇️";break;default:t=t.charAt(0).toUpperCase()+t.slice(1)}this.$set(this.currentGameConfig.keyBoard,e.key.toLowerCase(),{str:t,key:e.key,coordinate:`${640+Math.floor(101*Math.random())-50},${360+Math.floor(101*Math.random())-50}`,size:"small",bling:!0}),this.saveKeyboardLayout()}else Swal.fire({theme:"material-ui-dark",toast:!0,position:"bottom",icon:"error",title:"Binding W/A/S/D is not allowed.",showConfirmButton:!1,timer:2e3})}},disableKeyBling(e){const t=this.currentGameConfig.keyBoard[e];t&&(t.bling=!1,this.$set(this.currentGameConfig.keyBoard,e,t),this.saveKeyboardLayout())},removeKeyboardKey(e){this.currentGameConfig.keyBoard[e]&&(this.$delete(this.currentGameConfig.keyBoard,e),this.saveKeyboardLayout())},saveKeyboardLayout(){localStorage.setItem(`keyboardLayout:${this.selectLayout}:${this.checkGame}:center`,JSON.stringify(this.currentGameConfig.center)),localStorage.setItem(`keyboardLayout:${this.selectLayout}:${this.checkGame}:newKeyboard`,JSON.stringify(this.currentGameConfig.keyBoard))},loadKeyboardLayout(){const e=localStorage.getItem(`keyboardLayout:${this.checkGame}:newKeyboard`),t=localStorage.getItem(`keyboardLayout:${this.selectLayout}:${this.checkGame}:newKeyboard`);t?this.$set(this.currentGameConfig,"keyBoard",JSON.parse(t)):e?(this.$set(this.currentGameConfig,"keyBoard",JSON.parse(e)),localStorage.removeItem(`keyboardLayout:${this.checkGame}:newKeyboard`),localStorage.setItem(`keyboardLayout:${this.selectLayout}:${this.checkGame}:newKeyboard`,e)):this.defaultKeyboard&&this.$set(this.currentGameConfig,"keyBoard",JSON.parse(JSON.stringify(this.defaultKeyboard)));const i=localStorage.getItem(`keyboardLayout:${this.checkGame}:center`),s=localStorage.getItem(`keyboardLayout:${this.selectLayout}:${this.checkGame}:center`);s?(this.center=JSON.parse(s),this.$set(this.currentGameConfig,"center",this.center)):i?(this.center=JSON.parse(i),this.$set(this.currentGameConfig,"center",this.center),localStorage.removeItem(`keyboardLayout:${this.checkGame}:center`),localStorage.setItem(`keyboardLayout:${this.selectLayout}:${this.checkGame}:center`,i)):this.defaultCenter&&(this.center=JSON.parse(JSON.stringify(this.defaultCenter)),this.$set(this.currentGameConfig,"center",this.center))},keyStyle(e,t){if(e.location&&""!==e.location)return e.location;if(e.coordinate&&""!==e.coordinate&&"0,0"!==e.coordinate){const[t,i]=e.coordinate.split(",").map(Number);return`left: ${t/1280*100}%; bottom: ${(720-i)/720*100}%;`}return e.location},translationCenterLocation:(e,t)=>`left: ${e.x/1280*100}%; bottom: ${(720-e.y)/720*100}%;`,checkFullScreen:()=>null!==document.fullscreenElement,ballClick(){this.openMenu=!this.openMenu},ballStart(e){this.ballDragging=!0;const t=e.touches?e.touches[0].clientX:e.clientX,i=e.touches?e.touches[0].clientY:e.clientY,s=t-this.ballPosition.x,o=i-this.ballPosition.y,n=e=>{if(!this.ballDragging)return;const t=e.touches?e.touches[0].clientX:e.clientX,i=e.touches?e.touches[0].clientY:e.clientY,n=window.innerWidth-40,r=window.innerHeight-40;this.ballPosition.x=Math.max(0,Math.min(t-s,n)),this.ballPosition.y=Math.max(0,Math.min(i-o,r))},r=e=>{this.ballDragging=!1;const s=e.changedTouches?e.changedTouches[0].clientX:e.clientX,o=e.changedTouches?e.changedTouches[0].clientY:e.clientY,a=Math.abs(s-t),h=Math.abs(o-i);a<5&&h<5&&this.ballClick(),window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",r),window.removeEventListener("touchmove",n),window.removeEventListener("touchend",r)};window.addEventListener("mousemove",n),window.addEventListener("mouseup",r),window.addEventListener("touchmove",n,{passive:!1}),window.addEventListener("touchend",r)},isMobile:()=>navigator.userAgentData?navigator.userAgentData.mobile:/Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent),gameLoop(){this.updateLeftPosition(),this.updateRightPosition(),requestAnimationFrame(this.gameLoop)},updateLeftPosition(){if(this.supportLeftRocker){let e=this.leftRockerPosition.x,t=this.leftRockerPosition.y,i=this.dStep;if(this.leftRockerPressedKeys.w&&(t-=i),this.leftRockerPressedKeys.s&&(t+=i),this.leftRockerPressedKeys.a&&(e-=i),this.leftRockerPressedKeys.d&&(e+=i),!this.currentGameConfig)return;let s=this.center;const o=e,n=t;let r=!1;if(Math.sqrt(o*o+n*n)>this.dRadius){r=!0;const i=Math.atan2(n,o);e=this.dRadius*Math.cos(i),t=this.dRadius*Math.sin(i)}if(Math.floor(e)===Math.floor(this.leftRockerPosition.x)&&Math.floor(t)===Math.floor(this.leftRockerPosition.y))return;if(r||(e>t?(this.leftRockerRandom.y=this.leftRockerRandom.y>0?-1:1,t+=this.leftRockerRandom.y):(this.leftRockerRandom.x=this.leftRockerRandom.x>0?-1:1,e+=this.leftRockerRandom.x)),this.leftRockerPosition.x=e,this.leftRockerPosition.y=t,Object.keys(this.leftRockerPressedKeys).length>0){if(!this.leftRockerStart){const e=`touch>Touch start:10,${s.x+this.leftRockerPosition.x},${s.y+this.leftRockerPosition.y}`;this.sendDataChannelMessage(e),this.leftRockerStart=!0,this.leftRockerEnd=!1}const e=`touch>Touch move:10,${s.x+Math.floor(this.leftRockerPosition.x)},${s.y+Math.floor(this.leftRockerPosition.y)}`;this.sendDataChannelMessage(e)}}},changeIME(){this.remoteIME?this.sendDataChannelMessage("softinput>switch:remote"):(this.inputTextShow=!1,this.sendDataChannelMessage("softinput>switch:local"))},updateRightPosition(){if(this.supportRightRocker){let e=this.rightRockerPosition.x,t=this.rightRockerPosition.y,i=this.dStep;if(this.rightRockerPressedKeys.z&&(t-=i),this.rightRockerPressedKeys.v&&(t+=i),this.rightRockerPressedKeys.x&&(e-=i),this.rightRockerPressedKeys.c&&(e+=i),!this.currentGameConfig)return;let s=this.center;const o=e,n=t;let r=!1;if(Math.sqrt(o*o+n*n)>this.dRadius){r=!0;const i=Math.atan2(n,o);e=this.dRadius*Math.cos(i),t=this.dRadius*Math.sin(i)}if(Math.floor(e)===Math.floor(this.rightRockerPosition.x)&&Math.floor(t)===Math.floor(this.rightRockerPosition.y))return;if(r||(e>t?t+=Math.random()<.5?-1:1:e+=Math.random()<.5?-1:1),this.rightRockerPosition.x=e,this.rightRockerPosition.y=t,Object.keys(this.rightRockerPressedKeys).length>0){if(!this.rightRockerStart){const e=`touch>Touch start:11,${s.x+this.rightRockerPosition.x},${s.y+this.rightRockerPosition.y}`;this.sendDataChannelMessage(e),this.rightRockerStart=!0,this.rightRockerEnd=!1}const e=`touch>Touch move:11,${s.x+Math.floor(this.rightRockerPosition.x)},${s.y+Math.floor(this.rightRockerPosition.y)}`;this.sendDataChannelMessage(e)}}},pointerLock(){const e=document.getElementById("canvasCoc");document.pointerLockElement===e?(log.info("exitPointerLock"),document.exitPointerLock()):(log.info("requestPointerLock"),e.requestPointerLock())},exitPointerLock(){document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock()},pointerLockChange(){const e=document.getElementById("canvasCoc");document.pointerLockElement===e||document.mozPointerLockElement===e||document.webkitPointerLockElement===e?this.cursorLock=!0:(this.cursorLock&&(18!==this.lastKeyDownCode||(this.lastKeyDownCode=0)),this.cursorLock=!1,this.exitingPointerLock=!0,setTimeout((()=>{this.exitingPointerLock=!1}),100))},sendEnter(){this.sendDataChannelMessage(`softinput>action:${this.inputEnterType}`)},closeInput(){this.sendDataChannelMessage("softinput>hide")},sendText(){if(""!==this.prevInputTextStr&&this.prevInputTextStr===this.inputTextStr)return this.sendDataChannelMessage(`softinput>action:${this.inputEnterType}`),this.prevInputTextStr="",void(this.inputTextStr="");this.sendDataChannelMessage(`softinput>text_change:${this.inputTextCnt++}:0,99999,${this.inputTextStr}`),this.prevInputTextStr=this.inputTextStr,this.$refs.input.focus()},sendMute(){"toggleVideo>on"===this.muteBtn?(this.sendDataChannelMessage(this.muteBtn),this.muteBtn="toggleVideo>off"):(this.sendDataChannelMessage(this.muteBtn),this.muteBtn="toggleVideo>on")},sendES(e,t){let i={};i.type=e,i.ts=(new Date).getTime()+"",i.user_id=this.userId,"user_interaction"===e?(i.action=t,"connection_error"===t?(!1===this.streamingOn&&(i.action="connection_timeout"),i.steps=this.steps):"window_resizing"===t&&(i.resolution=this.$refs.gameDiv.clientWidth+"x"+this.$refs.gameDiv.clientHeight)):"rtc_client_metrics"===e&&(i.metrics=this.videoStats,this.sendCount++,i.count=this.sendCount),this.initParams.sendMetric&&""!==this.initParams.nenlyEsUrl&&axios.put("https://"+this.initParams.nenlyEsUrl,i)},sendMetric(e,t){this.initParams.sendMetric&&""!==this.initParams.metricUrl&&axios.post("https://"+this.initParams.metricUrl+"/v1/"+e,t)},getSocketUrl(){const e=new URLSearchParams(window.location.search);if(this.coordinator_host="",this.androidInstanceId="",this.userId="",this.androidInstance=null,e.has("userid")&&e.has("android_instance_id")&&e.has("game")){const t=e.get("coor_url");if(t&&(this.coordinator_host=t),this.androidInstanceId=e.get("android_instance_id"),this.userId=e.get("userid"),this.game=e.get("game"),this.androidInstanceId)try{this.androidInstance=JSON.parse(atob(this.androidInstanceId)),this.androidInstance&&""===this.coordinator_host&&(this.coordinator_host=this.androidInstance.coorUrl)}catch(e){}}return this.coordinator_host||`https://${window.location.hostname}`},screenDirection(){let e=this;setTimeout((()=>{e.resizeCount++,e.resizeCount>1&&(clearTimeout(e.sendResizeJob),e.sendResizeJob=setTimeout((()=>{e.sendES("user_interaction","window_resizing")}),1e3)),e.changeOrientation(e.direction)}),100)},reportStates(){this.dataChannelStartTimestamp=(new Date).getTime(),null!=this.dataChannel&&"open"===this.dataChannel.readyState&&this.dataChannel.send("stats>"),setTimeout((()=>{this.reportStates()}),this.initParams.statInterval)},adjustPlayoutDelayFromStats(e){const t=e.jitter??1,i=e.retransmittedPacketsReceived??0,s=e.packetsReceived??1,o=e.jitterBufferEmittedCount??1,n=e.jitterBufferMinimumDelay??0,r=s>0?i/s:1,a=o>0?n/o*1e3:100;let h=.2;h=t<.005&&r<.05&&a<70?.04:t<.01&&r<.1&&a<100?.1:.2;for(const e of this.pc.getReceivers())void 0!==e.jitterBufferTarget&&(e.jitterBufferTarget=h),void 0!==e.playoutDelayHint&&(e.playoutDelayHint=h),void 0!==e.jitterBufferDelayHint&&(e.jitterBufferDelayHint=h)},getStats(){let e=this;this.pc.getStats().then((t=>{t.forEach((t=>{if("video"===t.mediaType&&"inbound-rtp"===t.type&&(e.videoStats=t,e.sendES("rtc_client_metrics",""),this.adjustPlayoutDelayFromStats(t)),"candidate-pair"===t.type&&t.nominated&&(this.dataChannelDelay=1e3*t.currentRoundTripTime,this.dataChannelDelay=this.dataChannelDelay>999?999:this.dataChannelDelay),"peer-connection"===t.type){this.startTime||(this.startTime=t.timestamp);let e=Math.floor((t.timestamp-this.startTime)/1e3/60);if(e>0&&e<31&&!this.liveTimeSet.includes(e)){this.liveTimeSet.push(e),gtag("event",`play_for_${e}_min`)}}}))})).catch((e=>{})),setTimeout((()=>{this.getStats()}),1e3)},reportCoordinator(){this.statesBWE&&(log.info(this.statesBWE),this.socket.emit("metrics","bwe:"+(this.statesBWE/1024/1024).toFixed(3)+";rtt:"+this.statesRTT+";fpsin:"+this.statesFpsIn+";fpssent:"+this.statesFpsSent+";txbitrate:"+(0).toFixed(3)+";encodeMs:0;touchcount:0;videoPaused:"+(this.$refs.remoteVideo&&this.$refs.remoteVideo.paused)+";foreground:true"),this.socket.emit("metrics","ice state: "+this.pc.iceConnectionState+" signaling state: "+this.pc.signalingState+" iceGatheringState: "+this.pc.iceGatheringState)),setTimeout((()=>{this.reportCoordinator()}),3e3)},changeOrientation(e){this.pingOrient(),this.inputOrient(),this.keyboardOrient(),this.menuOrient();const t=this.$refs.gameDiv.clientHeight,i=this.$refs.gameDiv.clientWidth;let s,o;const n=1===e,r=this.screenWidth/this.screenHeight;n?(s=t,o=Math.round(t/r),o>i&&(o=i,s=Math.round(i*r)),this.$refs.remoteWrapper.style.transform="rotate(270deg)"):0===e&&(s=i,o=Math.round(i/r),o>t&&(o=t,s=Math.round(t*r)),this.videoWidth=s,this.videoHeight=o,this.$refs.remoteWrapper.style.transform="rotate(0deg)",this.$refs.remoteWrapper.style.right="auto",this.$refs.remoteWrapper.style.bottom=Math.abs((s-o)/2)+""),this.videoWidth=s,this.videoHeight=o,1===this.rotation?(this.$refs.remoteVideo.style.width=this.videoHeight+"px",this.$refs.remoteVideo.style.height=this.videoWidth+"px",this.$refs.remoteCanvas.style.width=this.videoHeight+"px",this.$refs.remoteCanvas.style.height=this.videoWidth+"px"):(this.$refs.remoteVideo.style.width=this.videoWidth+"px",this.$refs.remoteVideo.style.height=this.videoHeight+"px",this.$refs.remoteCanvas.style.width=this.videoWidth+"px",this.$refs.remoteCanvas.style.height=this.videoHeight+"px");const a=!(1===this.rotation||n);this.keyRotate=a,this.iconRotate=t>i},reconnectStreaming(){log.info("!!! reconnectStreaming"),log.info("streaming: "+this.streamingOn+", getout = "+this.getout),this.streamingOn||this.getout||(this.socket&&(log.info("### close old socket if exists"),this.socket.close()),this.connectStreaming())},connectStreaming(){this.createPeerConnection(),this.connectSocket()},connectSocket(){this.listenKeyup(),this.listenKeydown();let e=this.getSocketUrl();if(gtag("event","socket_connecting"),"https://0.0.0.0"===e||null==e||""===e)return this.pushSteps("Failed to connect to the game"),void this.parentPostMessage({start_cloud_game:!1});this.socket=io(e,{reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3,reconnectionDelayMax:1e4,randomizationFactor:.5,path:"/client/socket.io",pingInterval:1e4,pingTimeout:2e4,transports:["websocket"]}),this.socketBind()},socketBind(){let e=this;this.socket.on("hello_server",(()=>{e.pushSteps("Server has been successfully connected"),setTimeout((()=>{e.joinRoom()}),1e3)})),this.socket.on("connect",(()=>{gtag("event","socket_connected"),e.pushSteps("Server has been found")})),this.socket.on("action_done2",(e=>{this.socket.emit("metrics","join room"),this.socket.emit("metrics","ready to join room"),this.socket.emit("register",{roomid:e.signalingRoomId,clientid:"1111111"})})),this.socket.on("msg",(t=>{if(clearTimeout(this.clientRegisterTimer),this.clientRegisterTimer=null,t.type)switch(t.type){case"offer":this.joinRoomTimer&&clearTimeout(this.joinRoomTimer),e.pushSteps("Waiting for screen connection"),gtag("event","receive_offer"),0!=this.codec_type&&(t.sdp=this.priorCodecType(t.sdp,this.codec_type)),"VP8"!==this.codec&&"H264"!==this.codec||(t.sdp=this.setMediaCodec(t.sdp,"video","receive",this.codec)),t.sdp=this.priorCodecType(t.sdp,100),t.sdp=this.insertRRTRBoth(t.sdp),this.oldOffer=t,this.pc.setRemoteDescription(new RTCSessionDescription(t)),this.createAnswer();break;case"answer":this.pc.setRemoteDescription(new RTCSessionDescription(t));break;case"candidate":this.pc.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:t.label,candidate:t.candidate}));break;case"leave":log.info("msg leave")}})),this.socket.on("no_free_android",(()=>{log.info("### no_free_android")})),this.socket.on("getout",(t=>(clearTimeout(this.joinRoomTimer),clearTimeout(this.clientRegisterTimer),this.clientRegisterTimer=null,this.streamingOn=!1,1===(t=JSON.parse(t)).errorCode&&this.pushSteps("Server busy, please restart from the game list"),10===t.errorCode?(e.pushSteps("Screen has been successfully connected"),gtag("event","receive_stream"),this.streamingOn=!0,void this.socket.close()):7===t.errorCode||11===t.errorCode?(log.info("Connection error, "+t.msg),this.pushSteps("Server busy, please restart from the game list"),void this.socket.close()):12===t.errorCode?(log.info("Connection error, "+t.msg),this.pushSteps("Connection failed, please restart from the game list"),void this.socket.close()):(this.sendES("user_interaction","connection_error"),void this.parentPostMessage({start_cloud_game:!1}))))),this.socket.on("error",(t=>{loading(),e.dataChannel.close(),e.pc.close(),e.createPeerConnection(),log.info("error:"+JSON.stringify(t))})),this.socket.on("disconnect",(e=>{log.info("disconnect:"+JSON.stringify(e))}))},getIP(e){const t=e.match(/(\d{1,3}\.){3}\d{1,3}/);return t?t[0]:null},insertRRTRBoth:e=>e.replace(/(m=video.*\r\n)/,"$1a=rtcp-xr:rrtr\r\n").replace(/(m=audio.*\r\n)/,"$1a=rtcp-xr:rrtr\r\n"),joinRoom(){"false"!==this.initParams.gameName&&null==this.game&&(this.game=this.initParams.gameName),this.pushSteps("Room has been joined");let e={screenRes:this.screenWidth+"x"+this.screenHeight,game:this.game,userId:this.userId,slotId:this.userId+"@"+this.game,instanceId:this.androidInstanceId};this.socket.emit("client_register",e),this.joinRoomTimer=setTimeout((()=>{this.joinRoomCount>2?swal.fire({theme:"material-ui-dark",icon:"error",title:"Connection failed",text:"please restart from the game list",showConfirmButton:!1,allowOutsideClick:!1}):(this.joinRoomCount++,this.joinRoom())}),3e3),this.socket.emit("metrics",navigator.userAgent)},createDataChannel(){let e=this.pc.createDataChannel("config",{ordered:!0,reliable:!0});e.onerror=e=>{log.info("Data Channel Error: "+e),this.socket&&this.socket.emit("metrics","data channel error")},e.onmessage=e=>{this.handleDCMessage(e.data)},e.onopen=()=>{log.info("Data Channel opened: "+e.readyState),"open"!==e.readyState?(e.close(),e=null,this.createDataChannel()):(this.dataChannel.send("res>"+this.screenWidth+"x"+this.screenHeight),this.getStats(),this.socket&&this.socket.emit("metrics","data channel open"))},e.onclose=()=>{log.info("Data Channel Closed"),this.pc.close(),this.pc=null,this.dataChannel=null,this.socket&&this.socket.emit("metrics","data channel closed"),this.sendES("user_interaction","connection_error"),this.streamingOn=!1,this.parentPostMessage({start_cloud_game:!1})},this.dataChannel=e},fullScreen(){const e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()},exitFullScreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},handleDCMessage(msg){msg=msg.split(">"),"stats"!==msg[0]&&"inputDelay"!==msg[0]&&log.info("~~~",msg);let that=this;if("hide_cursor"===msg[0])this.exitingPointerLock||(this.cursorHide="1"===msg[1]);else if("rotation"===msg[0])removeLoading(),that.sendStartGame||(that.parentPostMessage({start_cloud_game:!0}),that.sendStartGame=!0,that.changeIME(),that.rotateScreenDC()),this.rotation=parseInt(msg[1]),this.rotateHandler();else if("touchState"===msg[0])this.enableTouch="true"===msg[1];else if("remotePay"===msg[0])window.android&&window.android.remotePay(msg[1]);else if("keyboard"===msg[0])msg[1].startsWith("show")?(this.inputTextShow=!0,this.sendDataChannelMessage("softinput>height:1"),this.inputTextStr="",this.prevInputTextStr="",this.sendText(),setTimeout((()=>{that.$refs.input.focus()}),100)):msg[1].startsWith("verify")||msg[1].startsWith("hide")&&(this.inputTextShow=!1,this.inputTextStr="",this.prevInputTextStr="");else if("stats"===msg[0]){let e=msg[1].split(",");for(let t=0;t<e.length;t++){let i=e[t].split(":");if("googAvailableSendBandwidth"===i[0]){let e=i[1],t=Number(e).toLocaleString("fullwide",{useGrouping:!1});this.statesBWE=t}else"googTransmitBitrate"===i[0]?this.statesTxBitrate=i[1]:"googAvgEncodeMs"===i[0]?this.statesEncodeMs=i[1]:"googFrameRateInput"===i[0]?this.statesFpsIn=i[1]:"googFrameRateSent"===i[0]?this.statesFpsSent=i[1]:"googRtt"===i[0]?(this.statesRTT=i[1],Number(this.statesRTT)<0&&(this.statesRTT=0)):"googCodecName"===i[0]&&""!==i[1]?this.statesCodecName=i[1]:"googFrameWidthSent"===i[0]?this.statesFrameWidth=i[1]:"googFrameHeightSent"===i[0]?this.statesFrameHeight=i[1]:"bytesSent"===i[0]&&(this.statesBytesSent=i[1])}}else if("cloudData"===msg[0]){window.parent.postMessage(msg[1],"*");let j=eval("("+msg[1]+")");j.loading_done&&(this.loadingDoneTime=Date.now(),this.sendMetric("loading_done",{game:this.game,env:this.initParams.env,delay:this.loadingDoneTime-this.openPageTime}))}else"pod_name"===msg[0]?(this.podName=msg[1],log.info("%c podName","color: blue; font-size: 14px",this.podName)):"kickout"===msg[0]?(this.getout=!0,this.socket.close(),log.info("%c client kickout","color: red; font-size: 14px",msg[1])):"locale"===msg[0]&&(this.podLocale=msg[1])},pushSteps(e){document.getElementById("step-msg").textContent=e,log.info("%c%s","color: #939597; font-size: 14px",e),this.steps.push((new Date).getTime()+":"+e)},rotateHandler(){const e=this.$refs.gameDiv.clientHeight,t=this.$refs.gameDiv.clientWidth;let i=this.$refs.remoteVideo.offsetWidth,s=this.$refs.remoteVideo.offsetHeight;1===this.rotation?(this.$refs.remoteVideo.style.width=s+"px",this.$refs.remoteVideo.style.height=i+"px",this.$refs.remoteCanvas.style.width=s+"px",this.$refs.remoteCanvas.style.height=i+"px",this.isRotate=!0,this.$refs.remoteCanvas.style.transformOrigin=(this.screenWidth/this.screenHeight/2*100).toFixed(2)+"% center",this.$refs.remoteVideo.style.transformOrigin=(this.screenWidth/this.screenHeight/2*100).toFixed(2)+"% center",this.isRotateScreen=t<=e):(this.$refs.remoteVideo.style.width=i+"px",this.$refs.remoteVideo.style.height=s+"px",this.$refs.remoteCanvas.style.width=i+"px",this.$refs.remoteCanvas.style.height=s+"px",this.isRotate=!1,this.isRotateScreen=t>e),this.changeOrientation(this.direction)},parentPostMessage(e){let t=JSON.stringify(e);window.parent.postMessage(t,"*")},handleTrack(e){let t=this;log.info("handle track"),e.track.onunmute=()=>{if("video"===e.track.kind)t.$refs.remoteVideo.srcObject!==e.streams[0]&&(log.info("bind video"),t.streamingConnectedTime=Date.now(),t.sendMetric("streaming_connected",{game:t.game,env:t.initParams.env,delay:t.streamingConnectedTime-t.openPageTime}),t.$refs.remoteVideo.srcObject=e.streams[0],t.remoteStream=e.streams[0],t.receivers=this.pc.getReceivers(),t.pushSteps("Game stream has been received"),this.socket&&this.socket.emit("metrics","videostart"));else{if("audio"!==e.track.kind)return;log.info("bind audio"),t.$refs.remoteAudio.srcObject!==e.streams[0]&&(t.$refs.remoteAudio.srcObject=e.streams[0])}},setTimeout((function(){null==t.$refs.remoteVideo.srcObject&&t.$refs.remoteVideo.srcObject!==e.streams[0]&&(t.$refs.remoteVideo.srcObject=e.streams[0],t.remoteStream=e.streams[0],t.receivers=this.pc.getReceivers(),log.info("received remote stream by setTimeout"),this.socket&&this.socket.emit("metrics","videostart"))}),1e3)},startGame(){this.$refs.remoteVideo.paused&&(this.$refs.remoteVideo.play(),this.socket&&this.socket.emit("metrics","startVideo: paused remoteVideo")),this.$refs.remoteAudio.paused&&this.$refs.remoteAudio.play(),this.showPlayBtn=!1},guid:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),createPeerConnection(){try{let e=this,t=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;this.pc=new t(this.pcConfiguration),this.pc.onicecandidate=this.handleIceCandidate,this.pc.oniceconnectionstatechange=function(){log.info("ice connection state:"+e.pc.iceConnectionState),gtag("event",`ice_connection_state_${e.pc.iceConnectionState}`)},this.pc.onconnectionstatechange=function(){log.info("connection state:"+e.pc.connectionState),"failed"===e.pc.connectionState&&(e.sendES("user_interaction","connection_error"),e.streamingOn=!1,e.parentPostMessage({start_cloud_game:!1}),swal.fire({theme:"material-ui-dark",icon:"error",title:"Connection failed",text:"please restart from the game list",showConfirmButton:!1,allowOutsideClick:!1}))},this.pc.onicegatheringstatechange=function(){log.info("ice gathering state:"+e.pc.iceGatheringState)},this.pc.onsignalingstatechange=function(){log.info("signaling state:"+e.pc.signalingState)},this.pc.ontrack=this.handleTrack,this.createDataChannel()}catch(e){this.parentPostMessage({start_cloud_game:!1}),log.info(e.message)}},rotateScreenDC(){if(void 0===this.scDirection)return this.scDirection=this.direction,log.info("first scDirection"),1===this.scDirection?(this.syncAccelerate="sensor>accelerate:-0.56410795_9.483055_2.0590239",this.syncRotate="sensor>rotate:0.60119915_0.19365342_0.18520845_0.756958_0.0"):(this.syncAccelerate="sensor>accelerate:9.552746_0.4022933_1.6402799",this.syncRotate="sensor>rotate:0.56005067_-0.31531847_0.65358347_0.397583_0.0"),"com.android.chrome"===this.game&&(this.isMobile()?(this.scDirection=1,this.syncAccelerate="sensor>accelerate:-0.56410795_9.483055_2.0590239",this.syncRotate="sensor>rotate:0.60119915_0.19365342_0.18520845_0.756958_0.0"):(this.scDirection=0,this.syncAccelerate="sensor>accelerate:9.552746_0.4022933_1.6402799",this.syncRotate="sensor>rotate:0.56005067_-0.31531847_0.65358347_0.397583_0.0")),void this.syncAccelerateDC();1===this.scDirection?(this.syncAccelerate="sensor>accelerate:9.552746_0.4022933_1.6402799",this.syncRotate="sensor>rotate:0.56005067_-0.31531847_0.65358347_0.397583_0.0",this.scDirection=0):(this.syncAccelerate="sensor>accelerate:-0.56410795_9.483055_2.0590239",this.syncRotate="sensor>rotate:0.60119915_0.19365342_0.18520845_0.756958_0.0",this.scDirection=1)},syncAccelerateDC(){setInterval((()=>{this.sendDataChannelMessage(this.syncAccelerate),this.sendDataChannelMessage(this.syncRotate)}),100)},handleIceCandidate(e){if(e.candidate){if("host"===e.candidate.type)return;let t={type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate};log.info("Start of candidates"+JSON.stringify(t)),this.sendMessage(t)}},createAnswer(){this.pc.createAnswer().then((e=>{if(this.pushSteps("Local parameters has been set"),this.bitRate>0){var t=e.sdp.split("\r\n");t.forEach(((e,i)=>{/^a=fmtp:\d*/.test(e)?t[i]=e+";x-google-max-bitrate="+this.bitRate+";x-google-min-bitrate=1000;x-google-start-bitrate=1000":/^a=mid:(1|video)/.test(e)&&(t[i]+="\r\nb=AS:"+this.bitRate)})),e.sdp=t.join("\r\n")}let i=e.sdp;e.sdp=i,this.oldAnswer=e,this.pc.setLocalDescription(e),this.sendMessage(e)}),(e=>{log.info("!!! createAnswer error："+e)}))},setMediaCodec(e,t,i,s){let o=t+" "+i+" codec";if(log.info("----------------------------------"),!s)return log.info("No preference on "+o+"."),e;log.info("Prefer "+o+": "+s);let n=e.split("\r\n"),r=-1;for(let e=0;e<n.length;e++)if(0===n[e].indexOf("m="+t)){r=e;break}if(-1===r)return e;let a=null;for(let e=0;e<n.length;e++){let t=this.findLineInRange(n,e,-1,"a=rtpmap",s);null!==t&&(a=this.getCodecPayloadTypeFromLine(n[t]),a&&(n[r]=this.setDefaultCodec(n[r],a)))}return e=n.join("\r\n")},findLineInRange(e,t,i,s,o){let n=-1!==i?i:e.length;for(let i=t;i<n;++i)if(0===e[i].indexOf(s)&&(!o||-1!==e[i].toLowerCase().indexOf(o.toLowerCase())))return i;return null},getCodecPayloadTypeFromLine(e){let t=new RegExp("a=rtpmap:(\\d+) [a-zA-Z0-9-]+\\/\\d+"),i=e.match(t);return i&&2===i.length?i[1]:null},setDefaultCodec(e,t){let i=e.split(" "),s=i.slice(0,3);s.push(t);for(let e=3;e<i.length;e++)i[e]!==t&&s.push(i[e]);return s.join(" ")},priorCodecType(e,t){let i=e.split("\r\n"),s=[];for(let e=0;e<i.length;e++)0===i[e].indexOf("m=video")&&(s[e]=e);return 0===s.length?e:(s.forEach((e=>{let s=i[e],o=s.split(" "),n=o.indexOf(t);for(;-1!==n;)o.splice(n,1),n=o.indexOf(t);let r=JSON.parse(JSON.stringify(o));o=((e,t,i)=>{r[t]=i;for(let i=t;i<e.length;i++)r[i+1]=e[i];return r})(o,3,JSON.stringify(t));const a=o.filter(((e,t,i)=>i.indexOf(e)===t));s=a.join(" "),i[e]=s})),e=i.join("\r\n"))},setMediaBitRate(e,t,i){let s=e.split("\r\n"),o=-1;for(let e=0;e<s.length;e++)if(0===s[e].indexOf("m="+t)){o=e;break}if(-1===o)return e;for(o++;0===s[o].indexOf("i=")||0===s[o].indexOf("c=");)o++;if(0===s[o].indexOf("b"))return o[o]="b=AS:"+i,s.join("\r\n");let n=s.slice(0,o);return n.push("b=AS:"+i),n=n.concat(s.slice(o,s.length)),n.join("\r\n")},sendMessage(e){log.info("send:"+e,0),this.socket.emit("msg",e)},mouseup(e){this.$refs.remoteVideo.muted||(this.$refs.remoteVideo.muted=!1),this.$refs.remoteAudio.muted&&(this.$refs.remoteAudio.muted=!1);const t=document.getElementById("canvasCoc"),i=document.pointerLockElement===t||document.mozPointerLockElement===t||document.webkitPointerLockElement===t,s=(this.currentGameConfig||{}).pointerLockCoordinate||{};if(i){let t="";if(0===e.button){let e=s.lClick??"1060,550";this.currentGameConfig?.keyBoard?.lClick&&"0,0"!==this.currentGameConfig?.keyBoard?.lClick?.coordinate&&(e=this.currentGameConfig?.keyBoard?.lClick?.coordinate),t=`touch>Touch end:5,${e}`}else if(2===e.button){let e=s.rClick??"1180,620";this.currentGameConfig?.keyBoard?.rClick&&"0,0"!==this.currentGameConfig?.keyBoard?.rClick?.coordinate&&(e=this.currentGameConfig?.keyBoard?.rClick?.coordinate),t=`touch>Touch end:9,${e}`}return void(t&&this.sendDataChannelMessage(t))}if(!this.sendMove)return;if(this.sendMove=!1,2===e.button){if(!this.supportRightClick)return;return void this.sendDataChannelMessage(`touch>Touch end:8,${this.dEyeCenter.x+Math.floor(this.dEyePosition.x)},${this.dEyeCenter.y+Math.floor(this.dEyePosition.y)}`)}let o=`touch>Mouse up:${e.button},${this.resizeHandler(e.offsetX)},${this.resizeHandler(e.offsetY)}`;this.sendDataChannelMessage(o)},mousedown(e){const t=document.getElementById("canvasCoc"),i=document.pointerLockElement===t||document.mozPointerLockElement===t||document.webkitPointerLockElement===t,s=this.currentGameConfig||{},o=s.pointerLockCoordinate||{};if(i){let t="";if(0===e.button){let e=o.lClick??"1060,550";this.currentGameConfig?.keyBoard?.lClick&&"0,0"!==this.currentGameConfig?.keyBoard?.lClick?.coordinate&&(e=this.currentGameConfig?.keyBoard?.lClick?.coordinate),t=`touch>Touch start:5,${e}`}else if(2===e.button){let e=o.rClick??"1180,620";if(this.currentGameConfig?.keyBoard?.rClick&&"0,0"!==this.currentGameConfig?.keyBoard?.rClick?.coordinate&&(e=this.currentGameConfig?.keyBoard?.rClick?.coordinate),"0,0"===e)return;t=`touch>Touch start:9,${e}`}return void(t&&this.sendDataChannelMessage(t))}if(2===e.button){if(!this.supportRightClick)return;return this.dEyePosition={x:0,y:0},this.dEyeCenter=s.rightClickCenter??{x:640,y:360},this.sendMove=!0,void this.sendDataChannelMessage(`touch>Touch start:8,${this.dEyeCenter.x},${this.dEyeCenter.y}`)}this.sendMove=!0;let n=`touch>Mouse down:${e.button},${this.resizeHandler(e.offsetX)},${this.resizeHandler(e.offsetY)}`;this.sendDataChannelMessage(n)},mousemove(e){const t=document.getElementById("canvasCoc"),i=document.pointerLockElement===t||document.mozPointerLockElement===t||document.webkitPointerLockElement===t;(this.currentGameConfig||{}).pointerLockCenter;if(i){const t=e.movementX??0,i=e.movementY??0;this.moveX+=t*this.mouseSensitivity,this.moveY+=i*this.mouseSensitivity;const s=this.$refs.remoteVideo.offsetWidth/2,o=this.$refs.remoteVideo.offsetHeight/2;this.moveX=Math.max(-s,Math.min(s,this.moveX)),this.moveY=Math.max(-o,Math.min(o,this.moveY));const n=this.currentGameConfig?.pointerLockCenter??{x:640,y:360};if(!this.pointerLockStart){let e=`touch>Touch start:8,${n.x},${n.y}`;this.sendDataChannelMessage(e),this.pointerLockStart=!0}let r=this.resizeHandler(this.moveX),a=this.resizeHandler(this.moveY),h=`touch>Touch move:8,${n.x+r},${n.y+a}`;return this.sendDataChannelMessage(h),this.resetMoveTimer&&clearTimeout(this.resetMoveTimer),void(this.resetMoveTimer=setTimeout((()=>{let e=`touch>Touch end:8,${n.x+r},${n.y+a}`;this.sendDataChannelMessage(e),this.moveX=0,this.moveY=0,this.pointerLockStart=!1}),200))}if(!this.sendMove)return;const s=2===e.buttons,o=0===e.button||this.alwaysSendMove;if(!this.supportRightClick&&s)return;if(this.supportRightClick&&s){let t=this.dEyePosition.x+e.movementX,i=this.dEyePosition.y+e.movementY;const s=t,o=i;if(Math.sqrt(s*s+o*o)>this.dEyeRadius){const e=Math.atan2(o,s);t=this.dEyeRadius*Math.cos(e),i=this.dEyeRadius*Math.sin(e)}return this.dEyePosition.x=t,this.dEyePosition.y=i,void this.sendDataChannelMessage(`touch>Touch move:8,${this.dEyeCenter.x+Math.floor(t)},${this.dEyeCenter.y+Math.floor(i)}`)}if(!o)return;this.lastMoveEvent=e;let n=`touch>Mouse move:${e.button},${this.resizeHandler(e.offsetX)},${this.resizeHandler(e.offsetY)}`;this.sendDataChannelMessage(n)},mousewheel(e){this.mousewheelFakeAndroid(e)},mouseleave(e){this.sendMove&&this.mouseup(this.lastMoveEvent)},mousewheelFakeAndroid(e){let t=e.wheelDelta;if(this.zoom){if(t<0){if(1===this.rotation)for(let e=0;e<=48;e+=16){let t="";t=0===e?"touch>Touch start:6,440,230:7,840,490":48===e?`touch>Touch end:6,${440+e},${230+e/16*5},:7,${840-e},${490-e/16*5}`:`touch>Touch move:6,${440+e},${230+e/16*5},:7,${840-e},${490-e/16*5}`,setTimeout((()=>{this.sendDataChannelMessage(t)}),2.5*e)}}else if(1===this.rotation)for(let e=0;e<=48;e+=16){let t="";t=0===e?"touch>Touch start:6,488,250:7,792,470":48===e?`touch>Touch end:6,${488-e},${250-e/16*5},:7,${792+e},${470+e/16*5}`:`touch>Touch move:6,${488-e},${250-e/16*5},:7,${792+e},${470+e/16*5}`,setTimeout((()=>{this.sendDataChannelMessage(t)}),2.5*e)}this.zoom=!1,setTimeout((()=>{this.zoom=!0}),300)}},getChangedTouchesString(e){let t="";for(let i=0;i<e.changedTouches.length;i++){let s=e.changedTouches[i],o=this.getMousePos(s.pageX,s.pageY);t+=":"+this.getTouchCounter(s.identifier)+","+o.x+","+o.y}return t},resizeHandler(e){let t=0,i=this.$refs.remoteVideo.offsetWidth,s=this.$refs.remoteVideo.offsetHeight;return t=i>s?this.initParams.screenWidth/i:this.initParams.screenWidth/s,this.scaleValue=t,Math.floor(e*t)},getMousePos(e,t){let i=this.$refs.containerDiv.getBoundingClientRect();e-=i.left,t-=i.top;let s,o,n=this.$refs.containerDiv.clientHeight,r=this.$refs.containerDiv.clientWidth,a=getComputedStyle(this.$refs.containerDiv),h=parseFloat(a.paddingTop),c=parseFloat(a.paddingBottom);return this.direction===GAME_VIEW_PORTRAIT?(s=this.videoWidth,o=this.videoHeight):(s=this.videoHeight,o=this.videoWidth),e-=(r-s)/2,t-=(n-o)/2-(c-h)/2,e=this.resizeHandler(e),t=this.resizeHandler(t),this.rotation===ANDROID_LANDSCAPE&&this.direction===GAME_VIEW_PORTRAIT?{x:Math.abs(t),y:Math.abs(e-this.screenWidth)}:this.rotation===ANDROID_LANDSCAPE&&this.direction===GAME_VIEW_LANDSCAPE?{x:e,y:t}:this.rotation===ANDROID_PORTRAIT&&this.direction===GAME_VIEW_LANDSCAPE?{x:Math.abs(t-this.screenWidth),y:Math.abs(e)}:(this.rotation===ANDROID_PORTRAIT&&this.direction,{x:e,y:t})},touchstart(e){let t="touch>Touch start"+this.getChangedTouchesString(e);this.sendDataChannelMessage(t)},touchmove(e){this.$refs.remoteVideo.muted&&(this.$refs.remoteVideo.muted=!1),this.$refs.remoteAudio.muted&&(this.$refs.remoteAudio.muted=!1);let t="touch>Touch move"+this.getChangedTouchesString(e);this.sendDataChannelMessage(t)},touchend(e){this.$refs.remoteVideo.muted||(this.$refs.remoteVideo.muted=!1),this.$refs.remoteAudio.muted&&(this.$refs.remoteAudio.muted=!1);let t="touch>Touch end"+this.getChangedTouchesString(e);this.socket.emit("metrics","bwe;;;;;;touches:1"),this.sendDataChannelMessage(t)},touchcancel(e){let t="touch>Touch endcancel"+this.getChangedTouchesString(e);this.sendDataChannelMessage(t)},listenKey(e){if(!e.key)return;let t="touch>Text:"+e.key;1!==e.key.length&&(t="touch>TextCmd:"+e.key),log.info(t),this.sendDataChannelMessage(t)},listenKeyUp(e){if(this.inputTextShow)return;if(!e.key)return;if(this.isEditKeyboard)return;if(e.keyCode>=112&&e.keyCode<=123)return;if(e.preventDefault(),"`"===e.key)return;this.keyDownMap[e.key]=!1;let t="";if(!e.altKey&&this.keyDownMap.Alt&&(t="touch>KeyUpCmd:Alt",this.sendDataChannelMessage(t),this.keyDownMap.Alt=!1),!e.ctrlKey&&this.keyDownMap.Control&&(t="touch>KeyUpCmd:Control",this.sendDataChannelMessage(t),this.keyDownMap.Control=!1),!e.shiftKey&&this.keyDownMap.Shift&&(t="touch>KeyUpCmd:Shift",this.sendDataChannelMessage(t),this.keyDownMap.Shift=!1),!e.metaKey&&this.keyDownMap.Meta&&(t="touch>KeyUpCmd:Meta",this.sendDataChannelMessage(t),this.keyDownMap.Meta=!1),!this.currentGameConfig?.keyBoard)return;const i=e.key.toLowerCase();e.code.toLowerCase();if(this.supportLeftRocker&&["w","a","s","d"].includes(i)&&(delete this.leftRockerPressedKeys[i],0===Object.keys(this.leftRockerPressedKeys).length)){let e=this.center;this.leftRockerEnd||(this.sendDataChannelMessage(`touch>Touch end:10,${e.x+Math.floor(this.leftRockerPosition.x)},${e.y+Math.floor(this.leftRockerPosition.y)}`),this.leftRockerPosition={x:0,y:0},this.leftRockerStart=!1,this.leftRockerEnd=!0)}if(this.supportRightRocker&&["z","x","c","v"].includes(i)&&(delete this.rightRockerPressedKeys[i],0===Object.keys(this.rightRockerPressedKeys).length)){let e=this.currentGameConfig.rightCenter;this.rightRockerEnd||(this.sendDataChannelMessage(`touch>Touch end:11,${e.x+Math.floor(this.rightRockerPosition.x)},${e.y+Math.floor(this.rightRockerPosition.y)}`),this.rightRockerPosition={x:0,y:0},this.rightRockerStart=!1,this.rightRockerEnd=!0)}document.querySelector(`.keyboard-key-${this.keyToKeyCode(i.toLowerCase())}`)?.classList.remove("keyboard-key-press");const s=this.currentGameConfig.keyBoard[i]?.coordinate;if(s&&"0,0"!==s){const e=this.getTouchCounter(i);this.sendDataChannelMessage(`touch>Touch end:${e},${s}`)}},listenKeyDown(e){if(!e.key)return;if(this.isEditKeyboard)return;if(e.keyCode>=112&&e.keyCode<=123)return;const t=e.target.tagName.toLowerCase(),i=e.target.isContentEditable;if("input"===t||"textarea"===t||i)return;if(e.preventDefault(),e.ctrlKey&&77===e.keyCode)return void(this.currentGameConfig?.pointerLock&&this.pointerLock());if(this.lastKeyDownCode=e.keyCode,this.lastKeyDownTime=(new Date).getTime(),this.keyDownMap[e.key])return;if(this.keyDownMap[e.key]=!0,!this.currentGameConfig?.keyBoard)return;const s=e.key.toLowerCase();e.code.toLowerCase();this.supportLeftRocker&&["w","a","s","d"].includes(s)&&(this.leftRockerPressedKeys[s]=!0),this.supportRightRocker&&["z","x","c","v"].includes(s)&&(this.rightRockerPressedKeys[s]=!0);document.querySelector(`.keyboard-key-${this.keyToKeyCode(s.toLowerCase())}`)?.classList.add("keyboard-key-press");const o=this.currentGameConfig.keyBoard[s]?.coordinate;if(o&&"0,0"!==o){const e=this.getTouchCounter(s);this.sendDataChannelMessage(`touch>Touch start:${e},${o}`)}},listenKeyup(){document.addEventListener("keyup",this.listenKeyUp)},listenKeyupDestroyed(){document.removeEventListener("keyup",this.listenKeyUp)},listenKeydown(){document.addEventListener("keydown",this.listenKeyDown)},listenKeydownDestroyed(){document.removeEventListener("keydown",this.listenKeyDown)},sendDataChannelMessage(e){this.showDataChannelMsg&&log.info("%cDataChannel: ","color: blue; font-size: 14px",e),this.pc&&this.dataChannel&&"open"===this.dataChannel.readyState&&(e.includes("touch")&&(this.$refs.remoteVideo.paused&&this.$refs.remoteVideo.play(),this.$refs.remoteAudio.paused&&this.$refs.remoteAudio.play()),this.dataChannel.send(e))},inputOrient(){let e=this.$refs.gameDiv.clientWidth,t=this.$refs.gameDiv.clientHeight,i=document.getElementById("input-div");e>=t?(i.style.transform="rotate(0)",i.style.left="0",i.style.bottom="20px",i.style.right="",i.style.top=""):(i.style.transform="rotate(90deg)",i.style.left="-75%",i.style.right="0",i.style.top="50%",i.style.bottom="50%")},pingOrient(){let e=this.$refs.containerDiv.clientWidth,t=this.$refs.containerDiv.clientHeight,i=document.getElementById("ping");if(e>=t)i.style.transform="rotate(0)",i.style.left="0",i.style.bottom="0%",i.style.width=e+"px";else{i.style.transform="rotate(90deg)",i.style.width=t+"px";let e=16,s=t;i.style.left="-"+(s-e)/2+"px",i.style.bottom=t-(s+e)/2+"px"}},keyboardOrient(){let e=document.getElementById("keyboard");1===this.direction?(e.style.transform="rotate(0)",e.style.left="0",e.style.right="0",e.style.top="0",e.style.bottom="0",this.showADiv&&1===this.initOrientation&&(this.hideVertical?(e.style.top="110px",e.style.bottom="110px"):e.style.bottom="110px")):(e.style.transform="translate(-50%, -50%) rotate(90deg)",e.style.left="50%",e.style.right="",e.style.top="50%",e.style.bottom="")},menuOrient(){let e=this.$refs.gameDiv.clientWidth,t=this.$refs.gameDiv.clientHeight,i=document.getElementById("menu");e>=t?(i.style.transform="rotate(0)",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0",i.style.width="100%",i.style.height="100%"):(i.style.transform="translate(-50%, -50%) rotate(90deg)",i.style.left="50%",i.style.top="50%",i.style.right="",i.style.bottom="",i.style.width="100vh",i.style.height="100vw")},getTouchCounter(e){return this.touchIdMap.has(e)||this.touchIdMap.set(e,this.touchCounter++),this.touchIdMap.get(e)},getUTCDate(){const e=new Date,[t,i,s,o,n,r]=[e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()].map((e=>String(e).padStart(2,"0")));this.utcDate=`${t}-${i}-${s} ${o}:${n}:${r}`}};